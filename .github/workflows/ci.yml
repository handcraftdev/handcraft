name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9.14.2"

jobs:
  # ============================================
  # Web App - Build & Lint
  # ============================================
  web:
    name: Web App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Build
        run: pnpm run build
        env:
          # Required secrets for build
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          CONTENT_ENCRYPTION_SECRET: ${{ secrets.CONTENT_ENCRYPTION_SECRET }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SOLANA_RPC_URL: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC_URL }}
          CONTENT_REGISTRY_PROGRAM_ID: ${{ secrets.CONTENT_REGISTRY_PROGRAM_ID }}
          # Storage
          FILEBASE_KEY: ${{ secrets.FILEBASE_KEY }}
          FILEBASE_SECRET: ${{ secrets.FILEBASE_SECRET }}
          FILEBASE_BUCKET: ${{ secrets.FILEBASE_BUCKET }}
          # Optional - webhooks
          HELIUS_WEBHOOK_SECRET: ${{ secrets.HELIUS_WEBHOOK_SECRET }}

  # ============================================
  # Solana Program - Build Check
  # ============================================
  program:
    name: Solana Program
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/v2.0.0/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked
          avm install 0.31.1
          avm use 0.31.1
          echo "$HOME/.avm/bin" >> $GITHUB_PATH

      - name: Build program
        run: anchor build

      - name: Verify IDL unchanged
        run: |
          if ! diff -q target/idl/content_registry.json packages/sdk/src/program/content_registry.json; then
            echo "IDL has changed! Run 'anchor build' and copy the IDL to packages/sdk/src/program/"
            exit 1
          fi

  # ============================================
  # Security Check
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit dependencies
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          if grep -rE "(sk_live_|pk_live_|ghp_|gho_|AKIA[A-Z0-9]{16})" --include="*.ts" --include="*.tsx" --include="*.js" .; then
            echo "Potential secrets found in code!"
            exit 1
          fi
